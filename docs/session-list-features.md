# Session List 功能清单

## 实现概览

文件: `/home/user/claude-code-open/src/session/list.ts`

- **代码行数**: 1063 行
- **导出函数**: 18 个
- **导出类型**: 5 个

## 核心功能模块

### 1. 列表和分页 ✓

- **函数**: `listSessionsEnhanced()`
- **功能**:
  - 支持分页查询 (limit/offset)
  - 返回总数和是否有更多数据
  - 自动缓存结果（1分钟TTL）
  - 返回结构化的 `ListSessionsResult`

### 2. 高级搜索 ✓

- **函数**: `searchSessions()`
- **功能**:
  - 全文搜索（ID、名称、工作目录、模型、标签）
  - 大小写不敏感
  - 支持与过滤条件组合使用
  - 返回匹配的会话摘要列表

### 3. 多维度过滤 ✓

- **接口**: `SessionFilter`
- **支持的过滤条件**:
  - `model`: 按模型过滤（支持单个或数组）
  - `dateFrom/dateTo`: 日期范围过滤
  - `minMessages/maxMessages`: 消息数量范围
  - `minCost/maxCost`: 成本范围
  - `workingDirectory`: 工作目录过滤
  - `tags`: 标签过滤（AND 逻辑）
  - `hasParent`: 是否为分支会话
  - `hasBranches`: 是否有子分支

### 4. 灵活排序 ✓

- **支持的排序字段**:
  - `createdAt`: 创建时间
  - `updatedAt`: 更新时间
  - `messageCount`: 消息数量
  - `cost`: 成本
- **排序方向**: `asc` (升序) 或 `desc` (降序)

### 5. 会话详情 ✓

- **函数**: `getSessionDetails()`
- **提供信息**:
  - 基础元数据（ID、名称、时间、模型等）
  - 工具使用统计（每个工具的调用次数）
  - 消息角色统计（用户/助手消息数）
  - 平均消息长度
  - 会话持续时间
  - 第一条和最后一条消息预览
  - 分支和合并信息

### 6. 批量操作 ✓

#### 6.1 批量删除
- **函数**: `bulkDeleteSessionsEnhanced()`
- **功能**:
  - 支持干运行模式（dryRun）
  - 返回成功和失败的ID列表
  - 自动清除缓存

#### 6.2 批量导出
- **函数**: `bulkExportSessions()`
- **功能**:
  - 导出多个会话到 Map
  - 支持 JSON/Markdown/HTML 格式
  - 返回每个会话的导出内容

#### 6.3 批量归档
- **函数**: `bulkArchiveSessions()`
- **功能**:
  - 移动会话到归档目录
  - 返回成功和失败的ID列表
  - 保持原始数据完整性

### 7. 多格式导出 ✓

#### 7.1 单会话导出
- **函数**: `exportSession()`
- **支持格式**:
  - **JSON**: 结构化数据，支持美化输出
  - **Markdown**: 可读性强的文本格式
  - **HTML**: 带样式的网页格式
- **导出选项**:
  - `includeMessages`: 是否包含消息内容
  - `includeMetadata`: 是否包含元数据
  - `prettyPrint`: JSON 格式化选项

#### 7.2 多会话导出
- **函数**: `exportMultipleSessions()`
- **功能**:
  - 合并多个会话到单个文件
  - JSON 格式返回数组
  - HTML 格式合并为单个文档
  - Markdown 格式用分隔符连接

#### 7.3 HTML 导出特性
- 响应式设计
- 语法高亮（代码块）
- 用户/助手消息样式区分
- 工具使用和结果的特殊样式
- 标签的视觉标记
- 自动 HTML 转义防止 XSS

### 8. 统计和报告 ✓

#### 8.1 统计信息
- **函数**: `getListStatistics()`
- **提供数据**:
  - 总会话数、消息数、Token数、成本
  - 平均值（成本、消息数、Token数）
  - 模型分布（每个模型的使用次数）
  - 标签分布（每个标签的使用次数）
  - 最旧/最新/最活跃会话

#### 8.2 报告生成
- **函数**: `generateSessionReport()`
- **支持格式**:
  - **文本**: 格式化的文本报告
  - **JSON**: 结构化数据报告
- **包含内容**:
  - 生成时间戳
  - 应用的过滤条件
  - 完整的统计信息
  - 会话列表（JSON格式）

### 9. 缓存机制 ✓

- **实现**: 内存缓存 Map
- **缓存键**: 基于查询选项的 JSON 字符串
- **缓存时长**: 60秒（可配置）
- **缓存管理**:
  - 自动过期机制
  - 手动清除函数 `clearSessionCache()`
  - 数据修改时自动清除

### 10. 归档功能 ✓

- **函数**: `archiveSession()`, `bulkArchiveSessions()`
- **功能**:
  - 移动会话到 `~/.claude/sessions/archive/` 目录
  - 保持原始数据和文件名
  - 支持批量归档
  - 自动创建归档目录
  - 返回操作结果

## 类型定义

### 1. `SessionFilter`
完整的过滤条件接口，支持所有过滤维度。

### 2. `SessionListOptions`
列表查询选项，包括分页、搜索、排序和过滤。

### 3. `SessionSummary`
会话摘要信息，包含关键元数据，不含消息内容（性能优化）。

### 4. `SessionDetails`
扩展的会话详情，包含统计信息和消息预览。

### 5. `ListSessionsResult`
列表查询结果，包含会话列表和分页信息。

### 6. `ExportOptions`
导出选项配置。

## 性能优化

1. **缓存机制**: 减少重复的文件系统访问
2. **分页支持**: 避免一次加载过多数据
3. **懒加载**: 摘要列表不加载完整消息内容
4. **批量操作**: 减少循环调用开销
5. **索引优化**: 快速过滤和排序

## 错误处理

- 文件读取失败时静默跳过（日志记录）
- 无效的会话文件自动忽略
- 批量操作返回成功/失败的详细列表
- 导出失败不影响其他会话的导出

## 安全特性

1. **HTML 转义**: 防止 XSS 攻击
2. **路径验证**: 确保文件操作在会话目录内
3. **权限控制**: 使用 0o600 权限保护会话文件
4. **输入验证**: 过滤条件的类型检查

## 扩展性

- **模块化设计**: 每个功能独立实现
- **类型安全**: 完整的 TypeScript 类型定义
- **可配置**: 缓存TTL、分页大小等可调整
- **插件友好**: 易于集成到 CLI 或 UI

## 使用场景

1. **CLI 工具**: 命令行会话管理
2. **Web Dashboard**: 会话浏览和管理界面
3. **自动化脚本**: 批量处理和归档
4. **报告生成**: 定期统计和分析
5. **备份工具**: 导出和备份重要会话
6. **审计日志**: 会话使用统计和成本追踪

## 与现有系统集成

- 完全兼容现有的 `session/index.ts`
- 复用现有的类型定义（`SessionData`, `SessionMetadata`）
- 通过 index.ts 统一导出
- 不影响现有功能

## 测试建议

1. 单元测试: 每个函数独立测试
2. 集成测试: 测试与文件系统的交互
3. 性能测试: 大量会话的处理性能
4. 边界测试: 空结果、无效输入等
5. 并发测试: 缓存机制的并发安全性

## 未来增强

1. 全文索引（如 SQLite FTS）
2. 更多导出格式（PDF、CSV）
3. 会话比较功能
4. 智能推荐（相似会话）
5. 图形化分支树展示
6. 实时会话监控
7. 自定义统计维度
8. 导出模板定制

## 依赖关系

- **核心依赖**: Node.js 内置模块（fs, path, os）
- **类型依赖**: 现有的 session/index.ts
- **零外部依赖**: 纯 TypeScript 实现

## 文件结构

```
src/session/
├── index.ts          # 主模块，导出所有功能
├── list.ts           # 新增：增强列表功能（1063行）
└── types.ts          # (如果需要) 可选的类型文件

docs/
├── session-list-features.md  # 本文档
└── session-list-examples.md  # 使用示例（24个示例）
```

## 总结

增强的会话列表功能提供了全面的会话管理能力，包括：

- ✅ 12个核心功能函数
- ✅ 6个辅助函数
- ✅ 5个类型定义
- ✅ 1063行高质量代码
- ✅ 完整的文档和示例
- ✅ 零外部依赖
- ✅ 类型安全
- ✅ 高性能
- ✅ 易于集成

这个模块为 Claude Code CLI 提供了企业级的会话管理能力，满足了从简单查询到复杂分析的各种需求。
