# CJK 输入法（IME）测试指南

## 快速测试

### 1. 启动应用

```bash
npm run dev
# 或
npm run start
```

### 2. 测试中文输入

1. 启用中文输入法（搜狗、微软拼音等）
2. 输入拼音：`ni hao`
3. **观察**：屏幕应显示 `[组合中] > 你好`（紫红色指示器）
4. 选择候选词
5. 按 Enter 键一次 → 结束组合状态（指示器消失）
6. 再按 Enter 键 → 提交消息

### 3. 测试日文输入

1. 启用日文输入法（Google 日本語入力等）
2. 输入罗马字：`konnichiha`
3. **观察**：显示 `[组合中] > こんにちは`
4. 按空格选择汉字：`今日は`
5. 按 Enter 结束组合
6. 再按 Enter 提交

### 4. 测试韩文输入

1. 启用韩文输入法
2. 输入韩文字符
3. **观察**：显示组合中指示器
4. 完成输入后按 Enter 提交

## 详细测试场景

### 场景 1：连续输入多个中文词

**步骤**：
1. 输入拼音：`wo ai zhong guo`
2. 选择候选词：`我爱中国`
3. **期望**：组合状态在每个词输入后延迟 500ms 自动结束
4. 按 Enter 两次提交

**验证点**：
- ✅ 组合指示器正确显示和隐藏
- ✅ 不会在选择候选词时误提交
- ✅ 最终正确提交完整内容

### 场景 2：中英文混合输入

**步骤**：
1. 输入英文：`Hello `
2. 切换到中文输入法
3. 输入拼音：`shi jie`
4. 选择：`世界`
5. 切换回英文
6. 输入：` World`
7. 按 Enter 提交

**期望结果**：`Hello 世界 World`

**验证点**：
- ✅ 中英文无缝切换
- ✅ 组合状态仅在 CJK 输入时触发
- ✅ 英文输入不影响正常 Enter 提交

### 场景 3：与自动补全的交互

**步骤**：
1. 输入斜杠：`/`
2. **观察**：显示命令补全列表
3. 按上下箭头选择命令
4. 按 Tab 应用补全
5. 继续输入中文参数
6. **观察**：组合指示器显示
7. 完成后提交

**验证点**：
- ✅ 补全功能正常工作
- ✅ 补全后可以继续 CJK 输入
- ✅ 组合状态不影响补全选择

### 场景 4：Vim 模式兼容性

**前置条件**：设置 `CLAUDE_CODE_VIM_MODE=true`

**步骤**：
1. 启动后进入 Normal 模式 `[N]`
2. 按 `i` 进入 Insert 模式 `[I]`
3. 输入中文
4. **观察**：同时显示 `[I]` 和 `[组合中]`
5. 按 ESC 返回 Normal 模式
6. 检查输入保留

**验证点**：
- ✅ Vim 模式与 IME 状态同时显示
- ✅ ESC 键可以退出 Insert 模式
- ✅ 组合状态独立管理

### 场景 5：历史搜索兼容性

**步骤**：
1. 先输入并提交一些中文消息
2. 按 Ctrl+R 启动历史搜索
3. 输入中文关键词搜索
4. **观察**：组合状态显示
5. 选择历史记录
6. 提交

**验证点**：
- ✅ 历史搜索支持中文
- ✅ 搜索时组合状态正常
- ✅ 选中历史记录后组合状态清除

## 边界情况测试

### 测试 1：快速连续输入

**步骤**：
1. 快速输入多个中文字符
2. 不等待组合超时
3. 直接按 Enter

**期望**：
- 第一次 Enter 结束组合
- 第二次 Enter 提交内容

### 测试 2：组合中途切换输入法

**步骤**：
1. 输入中文，进入组合状态
2. 切换到英文输入法
3. 继续输入
4. 按 Enter

**期望**：
- 组合状态在 500ms 后自动结束
- 或按 Enter 手动结束后再提交

### 测试 3：组合超时测试

**步骤**：
1. 输入一个中文字符
2. 等待 500ms
3. **观察**：组合指示器自动消失
4. 按 Enter 直接提交

**期望**：
- 组合状态自动结束
- Enter 键正常提交

### 测试 4：空输入提交

**步骤**：
1. 不输入任何内容
2. 直接按 Enter

**期望**：
- 不提交空消息
- 不显示组合指示器

## 性能测试

### 测试：长文本 CJK 输入

**步骤**：
1. 输入一段较长的中文文本（100+ 字符）
2. **观察**：
   - 组合指示器响应是否流畅
   - 字符显示是否有延迟
   - 内存占用是否正常

**验证点**：
- ✅ 无明显卡顿
- ✅ 组合状态及时更新
- ✅ 定时器正确清理

## 常见问题排查

### 问题 1：组合指示器不显示

**可能原因**：
- 终端不支持 UTF-8
- 输入法字符不在检测范围内

**解决方案**：
1. 检查终端编码设置
2. 查看 `isCJKChar()` 函数的 Unicode 范围
3. 添加日志确认字符码

```typescript
console.log('Char code:', input.charCodeAt(0).toString(16));
```

### 问题 2：组合状态一直不结束

**可能原因**：
- 定时器未正确清理
- 组合结束逻辑未触发

**解决方案**：
1. 按 Enter 手动结束
2. 按 ESC 清除输入
3. 检查 `compositionTimerRef` 清理逻辑

### 问题 3：Enter 键无响应

**可能原因**：
- 组合状态检测错误
- Enter 键被其他功能拦截

**解决方案**：
1. 等待组合超时（500ms）
2. 再次按 Enter
3. 检查是否有其他模式激活（Vim、补全等）

## 调试技巧

### 1. 启用详细日志

在 Input.tsx 的 useInput 回调中添加：

```typescript
console.log('[IME Debug]', {
  isComposing,
  input,
  charCode: input.charCodeAt(0),
  isCJK: isCJKChar(input),
});
```

### 2. 检查组合状态

在组件中添加：

```typescript
useEffect(() => {
  console.log('[Composition State]', isComposing);
}, [isComposing]);
```

### 3. 监控定时器

在 scheduleEndComposition 中添加：

```typescript
console.log('[Timer] Scheduled composition end in 500ms');
```

## 测试检查清单

- [ ] 中文输入正常
- [ ] 日文输入正常
- [ ] 韩文输入正常
- [ ] 中英文混合输入
- [ ] 组合指示器显示正确
- [ ] Enter 键智能处理
- [ ] 组合超时自动结束
- [ ] 与自动补全兼容
- [ ] 与 Vim 模式兼容
- [ ] 与历史搜索兼容
- [ ] 无性能问题
- [ ] 无内存泄漏

## 报告问题

如果发现问题，请提供以下信息：

1. **操作系统**：macOS / Windows / Linux
2. **终端模拟器**：iTerm2 / Windows Terminal / 等
3. **输入法**：搜狗 / 微软拼音 / Google 日本語 / 等
4. **复现步骤**：详细描述操作流程
5. **预期行为**：应该发生什么
6. **实际行为**：实际发生了什么
7. **日志输出**：控制台错误或调试日志

## 参考文档

- [IME_SUPPORT.md](/docs/IME_SUPPORT.md) - 完整功能文档
- [Input.tsx](/src/ui/components/Input.tsx) - 源代码实现
- [Unicode CJK Ranges](https://www.unicode.org/charts/PDF/U4E00.pdf) - Unicode 字符范围
