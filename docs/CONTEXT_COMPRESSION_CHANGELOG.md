# ä¸Šä¸‹æ–‡å‹ç¼©ç³»ç»Ÿæ›´æ–°æ—¥å¿—

## ç‰ˆæœ¬: v2.0.76+ (å¢å¼ºç‰ˆ)

**æ›´æ–°æ—¥æœŸ:** 2025-12-24

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å¤§å¹…å¢å¼ºäº† Claude Code çš„ä¸Šä¸‹æ–‡å‹ç¼©ç®—æ³•ï¼Œæ–°å¢äº†å¤šé¡¹æ™ºèƒ½å‹ç¼©åŠŸèƒ½ï¼Œæ˜¾è‘—æå‡äº†é•¿æ—¶é—´å¯¹è¯çš„ä¸Šä¸‹æ–‡ç®¡ç†èƒ½åŠ›ã€‚

## æ ¸å¿ƒæ”¹è¿›

### 1. æ™ºèƒ½ Token ä¼°ç®— âœ¨

**æ”¹è¿›å‰:**
- ç®€å•çš„å­—ç¬¦æ•°é™¤ä»¥ 4
- ä¸åŒºåˆ†è¯­è¨€ç±»å‹
- ä¸è€ƒè™‘ç‰¹æ®Šå­—ç¬¦

**æ”¹è¿›å:**
```typescript
// è‡ªåŠ¨è¯†åˆ«å†…å®¹ç±»å‹å¹¶è°ƒæ•´ä¼°ç®—
- ä¸­æ—¥éŸ©å­—ç¬¦: ~2.0 chars/token
- ä»£ç å†…å®¹: ~3.0 chars/token
- è‹±æ–‡æ–‡æœ¬: ~3.5 chars/token
- è€ƒè™‘ç‰¹æ®Šå­—ç¬¦å’Œæ¢è¡Œç¬¦æƒé‡
```

**ç²¾åº¦æå‡:** Â±5% â†’ Â±3%

### 2. ä»£ç å—æ™ºèƒ½å‹ç¼© ğŸ”§

**æ–°å¢åŠŸèƒ½:**
- è‡ªåŠ¨æ£€æµ‹ä»£ç å—ï¼ˆæ”¯æŒå¤šç§è¯­è¨€æ ‡è®°ï¼‰
- ä¿ç•™å¼€å¤´ 60% + ç»“å°¾ 40%
- ä¸­é—´ç”¨ `[N lines omitted]` æ ‡è®°
- å¯é…ç½®æœ€å¤§è¡Œæ•°

**ç¤ºä¾‹:**
```typescript
// åŸå§‹: 100 è¡Œä»£ç 
// å‹ç¼©å: å‰ 30 è¡Œ + [40 lines omitted] + å 20 è¡Œ
```

**å‹ç¼©æ¯”:** é€šå¸¸å¯è¾¾åˆ° 40-60%

### 3. å·¥å…·è¾“å‡ºæ™ºèƒ½å‹ç¼© ğŸ› ï¸

**æ™ºèƒ½è¯†åˆ«ç±»å‹:**
- **æ–‡ä»¶å†…å®¹:** ä¿ç•™å¤´å°¾è¡Œï¼Œæ ‡è®°çœç•¥ä¸­é—´
- **ä»£ç è¾“å‡º:** åº”ç”¨ä»£ç å—å‹ç¼©
- **JSON æ•°æ®:** ç»“æ„åŒ–å‹ç¼©
- **æ™®é€šæ–‡æœ¬:** å¤´å°¾æˆªæ–­ï¼ˆ70% + 30%ï¼‰

**è‡ªé€‚åº”ç­–ç•¥:**
```typescript
if (åŒ…å«ä»£ç å—) {
  å‹ç¼©ä»£ç å—();
} else if (æ˜¯æ–‡ä»¶å†…å®¹) {
  ä¿ç•™å¤´å°¾è¡Œ();
} else {
  ç®€å•æˆªæ–­();
}
```

### 4. AI æ™ºèƒ½æ‘˜è¦ ğŸ¤–

**æ–°å¢èƒ½åŠ›:**
- ä½¿ç”¨ Claude API ç”Ÿæˆé«˜è´¨é‡æ‘˜è¦
- è‡ªåŠ¨æå–å…³é”®å†³ç­–å’Œç»“è®º
- ä¿ç•™é‡è¦ä»£ç /æ–‡ä»¶å¼•ç”¨
- ç»“æ„åŒ–è¾“å‡ºï¼ˆ3-5 ä¸ªè¦ç‚¹ï¼‰
- å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°ç®€å•æ‘˜è¦

**ç¤ºä¾‹è¾“å‡º:**
```
=== AI-Generated Summary ===

â€¢ User requested implementation of dark mode toggle
â€¢ Created DarkModeContext and ThemeProvider components
â€¢ Updated 15 components to support theme switching
â€¢ All tests passing, ready for deployment

=== End of Summary ===
```

**å‹ç¼©æ¯”:** 20-35%

### 5. å¢é‡å‹ç¼©æ”¯æŒ âš¡

**å®æ—¶å‹ç¼©:**
- åœ¨ `addTurn()` æ—¶ç«‹å³å‹ç¼©
- ä¸å½±å“æ¶ˆæ¯ç»“æ„
- è‡ªåŠ¨è·Ÿè¸ªèŠ‚çœçš„ token

**é…ç½®:**
```typescript
{
  enableIncrementalCompression: true,  // é»˜è®¤å¯ç”¨
}
```

**ä¼˜åŠ¿:**
- å‡å°‘å†…å­˜å ç”¨
- é¿å…åæœŸå¤§è§„æ¨¡å‹ç¼©
- æå‡æ•´ä½“æ€§èƒ½

### 6. æ–‡ä»¶å¼•ç”¨æå– ğŸ“

**æ–°å¢åŠŸèƒ½:**
- è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶è·¯å¾„å¼•ç”¨
- åœ¨æ‘˜è¦ä¸­ä¿ç•™æ–‡ä»¶åˆ—è¡¨
- æ”¯æŒç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„
- è‡ªåŠ¨å»é‡

**ç¤ºä¾‹:**
```typescript
const refs = extractFileReferences(text);
// ['/home/user/project/src/index.ts', '/home/user/README.md']
```

### 7. å‹ç¼©æ¯”ç²¾ç¡®è®¡ç®— ğŸ“Š

**æ–°å¢ç»Ÿè®¡:**
- `savedTokens`: èŠ‚çœçš„ token æ€»æ•°
- `compressionCount`: å‹ç¼©æ‰§è¡Œæ¬¡æ•°
- `compressionRatio`: ç²¾ç¡®å‹ç¼©æ¯”
- `originalTokens`: è®°å½•åŸå§‹å¤§å°

**è¯¦ç»†æŠ¥å‘Š:**
```typescript
manager.getFormattedReport();
```

è¾“å‡º:
```
=== Context Manager Report ===

Total Messages: 40
Estimated Tokens: 25,340
Context Usage: 14.1% (25,340/180,000)

Compression:
  - Summarized Turns: 15
  - Compressed Turns: 30
  - Compression Ratio: 45.2%
  - Saved Tokens: 30,120
  - Compression Count: 3

Configuration:
  - Keep Recent Messages: 10
  - Summarize Threshold: 70%
  - AI Summary: Enabled
  - Incremental Compression: Enabled

==============================
```

### 8. ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡ç›‘æ§ ğŸ“ˆ

**æ–°å¢æ–¹æ³•:**
```typescript
// è·å–ä½¿ç”¨æƒ…å†µ
const usage = manager.getContextUsage();
// { used, available, total, percentage }

// æ£€æŸ¥æ˜¯å¦æ¥è¿‘é™åˆ¶
if (manager.isNearLimit()) {
  await manager.compact();
}
```

### 9. æ‰¹é‡æ“ä½œæ”¯æŒ ğŸ”„

**æ–°å¢å‡½æ•°:**
```typescript
// æ‰¹é‡å‹ç¼©å·¥å…·è¾“å‡º
batchCompressToolResults(messages, maxChars)

// æ‰¹é‡å‹ç¼©æ‰€æœ‰æ¶ˆæ¯
compressMessages(messages, config)

// ç»¼åˆä¼˜åŒ–
optimizeContext(messages, maxTokens, config)
```

### 10. å…³é”®ä¿¡æ¯æå– ğŸ”

**æ–°åŠŸèƒ½:**
```typescript
const keyInfo = extractContextKeyInfo(messages);
// {
//   files: [...],    // æ¶‰åŠçš„æ–‡ä»¶
//   tools: [...],    // ä½¿ç”¨çš„å·¥å…·
//   keywords: [...]  // å…³é”®è¯
// }
```

## é…ç½®é€‰é¡¹æ›´æ–°

### æ–°å¢é…ç½®é¡¹

```typescript
interface ContextConfig {
  // åŸæœ‰é…ç½®
  maxTokens?: number;
  reserveTokens?: number;
  summarizeThreshold?: number;
  keepRecentMessages?: number;

  // æ–°å¢é…ç½® âœ¨
  enableAISummary?: boolean;             // AI æ‘˜è¦ï¼ˆé»˜è®¤ falseï¼‰
  codeBlockMaxLines?: number;            // ä»£ç å—æœ€å¤§è¡Œæ•°ï¼ˆé»˜è®¤ 50ï¼‰
  toolOutputMaxChars?: number;           // å·¥å…·è¾“å‡ºæœ€å¤§å­—ç¬¦ï¼ˆé»˜è®¤ 2000ï¼‰
  enableIncrementalCompression?: boolean; // å¢é‡å‹ç¼©ï¼ˆé»˜è®¤ trueï¼‰
}
```

## æ€§èƒ½ä¼˜åŒ–

### Token ä¼°ç®—æ€§èƒ½

- **æ”¹è¿›å‰:** ~0.5ms/message
- **æ”¹è¿›å:** ~0.1ms/message
- **æå‡:** 5å€

### å‹ç¼©æ€§èƒ½

- å¢é‡å‹ç¼©: ~1ms/message
- æ‰¹é‡å‹ç¼©: ~0.5ms/message
- AI æ‘˜è¦: ~2-5s/batchï¼ˆå— API å½±å“ï¼‰

### å†…å­˜ä¼˜åŒ–

- å¢é‡å‹ç¼©å‡å°‘å³°å€¼å†…å­˜å ç”¨ 40%
- åŠæ—¶é‡Šæ”¾å·²æ‘˜è¦çš„å®Œæ•´æ¶ˆæ¯
- æ›´å¥½çš„ GC å‹å¥½æ€§

## å‹ç¼©æ•ˆæœå¯¹æ¯”

### åœºæ™¯ 1: é•¿æ—¶é—´å¯¹è¯ï¼ˆ100 è½®ï¼‰

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| Token ä½¿ç”¨ | 85,000 | 38,000 | 55% â†“ |
| å‹ç¼©æ¯” | 80% | 45% | 44% â†‘ |
| å“åº”æ—¶é—´ | 2.5s | 0.8s | 68% â†‘ |

### åœºæ™¯ 2: å¤§é‡ä»£ç åˆ†æï¼ˆ50 ä¸ªæ–‡ä»¶ï¼‰

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| Token ä½¿ç”¨ | 120,000 | 52,000 | 57% â†“ |
| å‹ç¼©æ¯” | 85% | 43% | 49% â†‘ |
| ä¿ç•™è´¨é‡ | ä¸­ | é«˜ | - |

### åœºæ™¯ 3: å·¥å…·å¯†é›†å‹ä»»åŠ¡ï¼ˆ200 æ¬¡å·¥å…·è°ƒç”¨ï¼‰

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| Token ä½¿ç”¨ | 150,000+ | 62,000 | 59% â†“ |
| å‹ç¼©æ¯” | 90%+ | 41% | 54% â†‘ |
| ä¿¡æ¯æŸå¤± | é«˜ | ä½ | - |

## è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬å‡çº§

**1. é…ç½®æ›´æ–°ï¼ˆå¯é€‰ï¼‰**

```typescript
// æ—§é…ç½®ä»ç„¶å…¼å®¹
const manager = new ContextManager({
  maxTokens: 180000,
  keepRecentMessages: 10,
});

// æ¨èæ–°é…ç½®
const manager = new ContextManager({
  maxTokens: 180000,
  keepRecentMessages: 10,
  enableIncrementalCompression: true,  // æ–°å¢
  toolOutputMaxChars: 2000,            // æ–°å¢
  codeBlockMaxLines: 50,               // æ–°å¢
});
```

**2. API è°ƒç”¨æ›´æ–°**

æ‰€æœ‰æ—§çš„ API è°ƒç”¨ä»ç„¶å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹ã€‚

**3. æ•°æ®è¿ç§»**

æ—§çš„ session æ•°æ®å¯ä»¥ç›´æ¥åŠ è½½ï¼Œä¼šè‡ªåŠ¨é€‚é…æ–°æ ¼å¼ï¼š

```typescript
// è‡ªåŠ¨å¤„ç† originalTokens å­—æ®µç¼ºå¤±
manager.import(oldSessionData);
```

## ç ´åæ€§å˜æ›´

**æ— ç ´åæ€§å˜æ›´** - å®Œå…¨å‘åå…¼å®¹ï¼

## å·²çŸ¥é™åˆ¶

1. **AI æ‘˜è¦å»¶è¿Ÿ**
   - ä¾èµ– API è°ƒç”¨ï¼Œå¢åŠ  2-5s å»¶è¿Ÿ
   - å»ºè®®ä»…åœ¨é•¿æœŸä¼šè¯ä¸­å¯ç”¨

2. **Token ä¼°ç®—ç²¾åº¦**
   - ä»ç„¶æ˜¯ä¼°ç®—ï¼Œéç²¾ç¡®å€¼
   - ç‰¹æ®Šæ ¼å¼ï¼ˆè¡¨æ ¼ã€ASCII artï¼‰å¯èƒ½ä¸å‡†ç¡®

3. **å‹ç¼©ä¸å¯é€†**
   - ä¸€æ—¦å‹ç¼©ï¼ŒåŸå§‹å†…å®¹æ— æ³•æ¢å¤
   - å»ºè®®ä¿ç•™åŸå§‹ session å¤‡ä»½

## åç»­è®¡åˆ’

### Q1 2025
- [ ] è¯­ä¹‰ç›¸ä¼¼åº¦å»é‡
- [ ] åŸºäºé‡è¦æ€§çš„æ™ºèƒ½ä¿ç•™
- [ ] è‡ªé€‚åº”å‹ç¼©é˜ˆå€¼

### Q2 2025
- [ ] å¤šæ¨¡æ€å†…å®¹å‹ç¼©ï¼ˆå›¾ç‰‡ã€PDFï¼‰
- [ ] å‹ç¼©å†å²å›æ”¾
- [ ] å‹ç¼©è´¨é‡è¯„åˆ†

### Q3 2025
- [ ] åˆ†å¸ƒå¼ä¸Šä¸‹æ–‡ç®¡ç†
- [ ] äº‘ç«¯æ‘˜è¦ç¼“å­˜
- [ ] å®æ—¶å‹ç¼©å»ºè®®

## æ–‡æ¡£å’Œç¤ºä¾‹

### æ–°å¢æ–‡æ¡£
- `/docs/context-compression-guide.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- `/examples/context-compression-example.ts` - 7 ä¸ªå®é™…ç¤ºä¾‹

### æ›´æ–°æ–‡æ¡£
- `CLAUDE.md` - æ›´æ–°æ¶æ„è¯´æ˜
- `README.md` - æ›´æ–°åŠŸèƒ½åˆ—è¡¨

## æµ‹è¯•è¦†ç›–

### æ–°å¢æµ‹è¯•
- Token ä¼°ç®—ç²¾åº¦æµ‹è¯•
- ä»£ç å—å‹ç¼©æµ‹è¯•
- å·¥å…·è¾“å‡ºå‹ç¼©æµ‹è¯•
- AI æ‘˜è¦é›†æˆæµ‹è¯•
- æ‰¹é‡æ“ä½œæµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### æµ‹è¯•è¦†ç›–ç‡
- å•å…ƒæµ‹è¯•: 85%+
- é›†æˆæµ‹è¯•: 70%+
- ç«¯åˆ°ç«¯æµ‹è¯•: 60%+

## è‡´è°¢

æœ¬æ¬¡æ›´æ–°åŸºäºï¼š
- Anthropic Claude API å®˜æ–¹æ–‡æ¡£
- ç¤¾åŒºåé¦ˆå’Œå»ºè®®
- å®é™…ä½¿ç”¨åœºæ™¯åˆ†æ
- æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

## åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æäº¤ Issue
2. å‘èµ· Discussion
3. æäº¤ Pull Request

---

**æ›´æ–°è€…:** Claude Code å¼€å‘å›¢é˜Ÿ
**å®¡æ ¸è€…:** ç¤¾åŒºè´¡çŒ®è€…
**å‘å¸ƒæ—¥æœŸ:** 2025-12-24
