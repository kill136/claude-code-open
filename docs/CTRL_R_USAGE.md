# Ctrl+R 反向历史搜索功能使用指南

## 功能概述

Ctrl+R 是一个强大的反向历史搜索功能，类似于 Bash/Zsh 终端中的历史搜索。它允许你快速查找并重用之前执行过的命令。

## 使用方法

### 1. 启动历史搜索

在输入框中，按 `Ctrl+R` 进入反向历史搜索模式。

### 2. 搜索命令

- **输入搜索关键词**：直接输入你想搜索的内容，系统会实时过滤匹配的历史命令
- **查看匹配结果**：搜索界面会显示所有匹配的命令，当前选中的会高亮显示

### 3. 导航匹配结果

- `Ctrl+R`：跳转到下一个匹配项（向后搜索）
- `Ctrl+S`：跳转到上一个匹配项（向前搜索）
- `Backspace`：删除搜索关键词的最后一个字符

### 4. 选择或取消

- `Enter`：选择当前匹配的命令并填入输入框
- `Esc`：取消搜索，恢复原来的输入内容

## 界面说明

搜索模式下会显示：

```
(reverse-i-search)`搜索词': 匹配的命令
[当前索引/总数 matches] (Ctrl+R: next, Ctrl+S: prev, Enter: select, Esc: cancel)
```

如果有多个匹配项，还会列出最近的几条：

```
▶ 当前选中的命令
  其他匹配命令1
  其他匹配命令2
  ...
  ... and X more
```

## 历史记录管理

### 自动保存

- 每次提交命令时自动保存到历史记录
- 历史记录持久化存储在 `~/.claude/command_history.json`
- 最多保存 1000 条历史记录
- 自动去重，相同命令只保留最新的一次

### 历史文件位置

- **Linux/macOS**: `~/.claude/command_history.json`
- **Windows**: `%USERPROFILE%\.claude\command_history.json`

## 实现细节

### 核心组件

1. **HistoryManager** (`src/ui/utils/history-manager.ts`)
   - 负责历史记录的持久化存储
   - 提供搜索、添加、清空等功能

2. **HistorySearch** (`src/ui/components/HistorySearch.tsx`)
   - 显示搜索界面
   - 高亮显示匹配的关键词
   - 列出匹配结果

3. **Input Component** (`src/ui/components/Input.tsx`)
   - 集成 Ctrl+R 快捷键处理
   - 管理搜索状态和交互

### 快捷键列表

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+R` | 进入/下一个匹配项 |
| `Ctrl+S` | 上一个匹配项 |
| `Enter` | 选择当前匹配 |
| `Esc` | 取消搜索 |
| `Backspace` | 删除搜索字符 |
| 任意字符 | 添加到搜索关键词 |

## 示例

### 示例 1：搜索文件操作命令

1. 按 `Ctrl+R`
2. 输入 `read`
3. 系统显示包含 "read" 的所有历史命令
4. 按 `Ctrl+R` 切换到下一个匹配
5. 按 `Enter` 选择当前命令

### 示例 2：搜索特定路径

1. 按 `Ctrl+R`
2. 输入 `/src/`
3. 系统显示所有包含 "/src/" 路径的历史命令
4. 按 `Enter` 选择

### 示例 3：取消搜索

1. 按 `Ctrl+R`
2. 输入搜索词
3. 按 `Esc` 取消，恢复原来的输入

## 注意事项

1. **大小写不敏感**：搜索时不区分大小写
2. **实时过滤**：每输入一个字符都会立即更新匹配结果
3. **循环导航**：在匹配列表中可以循环导航（到最后一个后会回到第一个）
4. **自动去重**：相同的命令只会保留最新的一次记录
5. **与其他功能兼容**：搜索模式下会禁用自动补全等其他功能

## 故障排除

### 历史记录没有保存

检查 `~/.claude/` 目录是否有写入权限：

```bash
ls -la ~/.claude/
chmod 755 ~/.claude/
```

### 搜索无结果

确认你之前确实执行过相关命令，历史记录文件存在且不为空：

```bash
cat ~/.claude/command_history.json
```

### 快捷键冲突

如果 `Ctrl+R` 与其他程序冲突，请检查终端配置或关闭冲突的程序。

## 未来改进

- [ ] 支持正则表达式搜索
- [ ] 支持按时间、频率排序
- [ ] 支持标记常用命令
- [ ] 支持导出/导入历史记录
- [ ] 支持多个历史记录配置文件

## 参考

- Bash 的 reverse-i-search 功能
- Zsh 的历史搜索功能
- Fish Shell 的历史建议功能
