<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Ontology Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>📊 Code Ontology Map</h1>
    <div class="search-box">
      <input type="text" id="search" placeholder="搜索模块、类、函数...">
    </div>
    <div class="controls">
      <button id="zoom-in">+</button>
      <button id="zoom-out">-</button>
      <button id="reset">重置</button>
      <select id="view-mode">
        <option value="story">📖 业务故事</option>
        <option value="reading">📚 代码阅读</option>
        <option value="beginner">🎯 新手导览</option>
        <option value="flowchart">流程图</option>
        <option value="architecture">架构概览</option>
        <option value="dependency">依赖图</option>
        <option value="entry-tree">入口树</option>
      </select>
    </div>
    <div class="entry-selector" id="entry-selector">
      <label>入口点:</label>
      <select id="entry-point"></select>
      <label>深度:</label>
      <select id="max-depth">
        <option value="3">3层</option>
        <option value="5" selected>5层</option>
        <option value="8">8层</option>
        <option value="10">10层</option>
      </select>
    </div>
    <div class="scenario-selector" id="scenario-selector">
      <label>场景:</label>
      <select id="scenario-select"></select>
    </div>
  </header>

  <div class="breadcrumb" id="breadcrumb"></div>

  <main>
    <div class="beginner-view" id="beginner-view">
      <div class="project-intro" id="beginner-intro"></div>
      <div class="module-cards" id="module-cards"></div>
    </div>

    <div class="story-view" id="story-view">
      <div class="story-header" id="story-header"></div>
      <div class="story-list" id="story-list"></div>
      <div class="story-detail" id="story-detail"></div>
    </div>

    <div class="reading-view" id="reading-view">
      <div class="reading-header" id="reading-header"></div>
      <div class="reading-paths" id="reading-paths"></div>
      <div class="reading-content" id="reading-content"></div>
    </div>

    <aside id="sidebar">
      <h2>统计</h2>
      <div id="stats"></div>
      <div class="module-list">
        <h2>模块</h2>
        <div id="module-list"></div>
      </div>
    </aside>

    <section id="graph-container">
      <div class="loading">加载中...</div>
      <svg id="graph"></svg>
      <button class="back-btn" id="back-btn">← 返回上级</button>
      <div class="project-header" id="project-header">
        <h2 id="project-name"></h2>
        <p id="project-desc"></p>
      </div>
      <div class="depth-indicator" id="depth-indicator">
        <div>颜色表示层级深度</div>
        <div class="depth-legend">
          <div class="depth-legend-item"><span class="color-box" style="background:#e94560"></span>入口</div>
          <div class="depth-legend-item"><span class="color-box" style="background:#533483"></span>1层</div>
          <div class="depth-legend-item"><span class="color-box" style="background:#0f3460"></span>2层</div>
          <div class="depth-legend-item"><span class="color-box" style="background:#16213e;border:1px solid #0f3460"></span>更深</div>
          <div class="depth-legend-item"><span class="color-box" style="background:#ff6b6b"></span>循环</div>
        </div>
      </div>
      <div class="arch-legend" id="arch-legend">
        <h3>图例说明</h3>
        <div class="arch-legend-item"><span class="color-box" style="background:#e94560"></span>入口层</div>
        <div class="arch-legend-item"><span class="color-box" style="background:#533483"></span>核心引擎</div>
        <div class="arch-legend-item"><span class="color-box" style="background:#0f3460;border:1px solid #4ecdc4"></span>功能模块</div>
        <div class="arch-legend-item"><span class="color-box" style="background:#16213e;border:1px solid #e94560"></span>用户界面</div>
        <div class="arch-legend-item"><span class="color-box" style="background:#16213e;border:1px solid #888"></span>配置/工具</div>
        <p style="margin-top:0.5rem;color:#888;font-size:0.75rem">双击模块下钻查看<br>点击查看详情</p>
      </div>
      <div class="symbol-legend" id="symbol-legend">
        <h3>符号类型</h3>
        <div class="symbol-legend-item"><span class="color-box" style="background:#e94560"></span>类 Class</div>
        <div class="symbol-legend-item"><span class="color-box" style="background:#533483"></span>接口 Interface</div>
        <div class="symbol-legend-item"><span class="color-box" style="background:#0f3460;border:1px solid #4ecdc4"></span>函数 Function</div>
        <div class="symbol-legend-item"><span class="color-box" style="background:#16213e;border:1px solid #888"></span>类型 Type</div>
        <div class="symbol-legend-item"><span class="color-box" style="background:#16213e;border:1px solid #ff6b6b"></span>常量 Constant</div>
        <div class="symbol-legend-item"><span class="color-box" style="background:#2d3436;border:1px solid #00cec9"></span>导出 Export</div>
        <p style="margin-top:0.5rem;color:#888;font-size:0.75rem">双击符号查看引用<br>点击查看详情</p>
      </div>
      <div class="flowchart-legend" id="flowchart-legend">
        <h3>流程图图例</h3>
        <div class="flowchart-legend-item"><span class="flow-shape entry"></span>入口点</div>
        <div class="flowchart-legend-item"><span class="flow-shape process"></span>处理过程</div>
        <div class="flowchart-legend-item"><span class="flow-shape subprocess"></span>子流程/类</div>
        <div class="flowchart-legend-item"><span class="flow-shape data"></span>数据/配置</div>
        <div class="flowchart-legend-item"><span class="flow-shape end"></span>结束</div>
        <p style="margin-top:0.5rem;color:#888;font-size:0.75rem">点击节点查看详情<br>选择场景切换流程</p>
      </div>
      <div class="flowchart-title" id="flowchart-title"></div>
    </section>

    <aside id="details-panel">
      <h2>详情</h2>
      <div id="node-details"></div>
    </aside>
  </main>

  <div id="search-results"></div>

  <div class="code-modal" id="code-modal" onclick="closeCodeModal(event)">
    <div class="code-modal-content vscode-style" onclick="event.stopPropagation()">
      <div class="code-modal-titlebar">
        <div class="titlebar-left">
          <span class="titlebar-icon">📄</span>
          <span id="code-modal-title">Code Preview</span>
        </div>
        <div class="titlebar-actions">
          <button class="titlebar-btn" onclick="toggleOutline()" title="符号大纲">📋</button>
          <button class="titlebar-btn" onclick="toggleAIPanel()" title="AI 助手">🤖</button>
          <button class="titlebar-btn" onclick="toggleMinimap()" title="切换小地图">🗺️</button>
          <button class="titlebar-btn" onclick="toggleWordWrap()" title="切换自动换行">↩️</button>
          <button class="titlebar-btn close" onclick="closeCodeModal()" title="关闭">✕</button>
        </div>
      </div>

      <div class="code-modal-tabs">
        <div class="tab active" id="code-tab">
          <span class="tab-icon">📄</span>
          <span class="tab-name" id="code-modal-filename">loading...</span>
          <span class="tab-close" onclick="closeCodeModal()">×</span>
        </div>
      </div>

      <div class="code-modal-breadcrumb" id="code-modal-breadcrumb">
        <span class="breadcrumb-path" id="code-modal-filepath">loading...</span>
      </div>

      <div class="code-modal-body">
        <div class="outline-panel" id="outline-panel">
          <div class="panel-header">
            <span>📋 符号大纲</span>
            <button class="panel-close" onclick="toggleOutline()">×</button>
          </div>
          <div class="outline-search">
            <input type="text" id="outline-search" placeholder="搜索符号..." oninput="filterOutline(this.value)">
          </div>
          <div class="outline-list" id="outline-list"></div>
        </div>

        <div class="editor-area">
          <div class="code-modal-semantic" id="code-modal-semantic" style="display:none"></div>
          <div class="monaco-container" id="monaco-container">
            <div class="code-loading" id="monaco-loading">
              <div class="loading-spinner"></div>
              <span>Loading Monaco Editor...</span>
            </div>
          </div>
          <div class="selection-toolbar" id="selection-toolbar" style="display:none">
            <button onclick="explainSelection()" title="AI 解释这段代码">🤖 解释</button>
            <button onclick="findReferences()" title="查找引用">🔍 引用</button>
            <button onclick="askAboutSelection()" title="提问">❓ 提问</button>
          </div>
        </div>

        <div class="ai-panel" id="ai-panel">
          <div class="panel-header">
            <span>🤖 AI 代码助手</span>
            <button class="panel-close" onclick="toggleAIPanel()">×</button>
          </div>
          <div class="ai-chat" id="ai-chat">
            <div class="ai-welcome">
              <div class="ai-avatar">🤖</div>
              <div class="ai-message">
                <p><strong>你好！我是 AI 代码助手</strong></p>
                <p>我可以帮你理解这份代码：</p>
                <ul>
                  <li>选中任意代码，点击"解释"</li>
                  <li>点击符号大纲中的函数/类</li>
                  <li>直接在下方输入问题</li>
                </ul>
              </div>
            </div>
            <div id="ai-messages"></div>
          </div>
          <div class="quick-questions">
            <button onclick="quickAsk('这个文件是做什么的？')">📄 文件功能</button>
            <button onclick="quickAsk('核心逻辑是什么？')">💡 核心逻辑</button>
            <button onclick="quickAsk('有什么依赖？')">🔗 依赖关系</button>
            <button onclick="quickAsk('如何使用？')">📖 使用方法</button>
          </div>
          <div class="ai-input-area">
            <textarea id="ai-input" placeholder="输入你的问题... (Enter 发送)" rows="2" onkeydown="handleAIInput(event)"></textarea>
            <button onclick="sendAIQuestion()" class="ai-send-btn">发送</button>
          </div>
        </div>
      </div>

      <div class="code-statusbar">
        <div class="statusbar-left">
          <span class="status-item" id="code-status-position">Ln 1, Col 1</span>
          <span class="status-item" id="code-status-selection"></span>
        </div>
        <div class="statusbar-right">
          <span class="status-item clickable" onclick="toggleAIPanel()" title="AI 助手">🤖 AI</span>
          <span class="status-item" id="code-status-language">TypeScript</span>
          <span class="status-item" id="code-status-encoding">UTF-8</span>
          <span class="status-item" id="code-status-lines">0 lines</span>
        </div>
      </div>

      <div class="smart-hover-tooltip" id="smart-hover-tooltip">
        <div class="smart-hover-header">
          <div class="title">
            <span class="icon">🧠</span>
            <span>智能代码解析</span>
          </div>
          <button class="close-btn" onclick="closeSmartHover()">×</button>
        </div>
        <div class="smart-hover-content" id="smart-hover-content"></div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>