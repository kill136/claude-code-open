# å·¥å…·è°ƒç”¨æµå¼å¤„ç†éªŒè¯æ‘˜è¦

## ğŸ“‹ éªŒè¯æ¦‚å†µ

- **éªŒè¯æ—¥æœŸ**: 2025-12-28
- **ç›®æ ‡**: éªŒè¯å·¥å…·è°ƒç”¨æµå¼å¤„ç†åŠŸèƒ½çš„æ­£ç¡®æ€§
- **å‚è€ƒ**: Claude Code v2.0.76 å®˜æ–¹å®ç°
- **ç»“æœ**: âœ… **éªŒè¯é€šè¿‡**

## ğŸ¯ éªŒè¯èŒƒå›´

### æ ¸å¿ƒæ–‡ä»¶
1. **src/core/client.ts** (406-550è¡Œ)
   - `createMessageStream()` æ–¹æ³•
   - å¤„ç† Anthropic API æµå¼äº‹ä»¶
   - è½¬æ¢ä¸ºåº”ç”¨å±‚äº‹ä»¶

2. **src/core/loop.ts** (298-434è¡Œ)
   - `processMessageStream()` æ–¹æ³•
   - å¤„ç†å·¥å…·è°ƒç”¨æµå¼äº‹ä»¶
   - æ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœ

3. **src/streaming/message-stream.ts** (æ•´ä¸ªæ–‡ä»¶)
   - `EnhancedMessageStream` ç±»
   - å®¹é”™ JSON è§£æ
   - å„ç§ delta å¤„ç†

4. **src/streaming/sse.ts** (æ•´ä¸ªæ–‡ä»¶)
   - SSE åè®®è§£æå™¨
   - å­—èŠ‚æµå¤„ç†

## âœ… éªŒè¯çš„åŠŸèƒ½ç‚¹

### 1. æµå¼äº‹ä»¶å¤„ç†
```
âœ“ message_start      - æ¶ˆæ¯å¼€å§‹
âœ“ content_block_start - å†…å®¹å—å¼€å§‹
âœ“ content_block_delta - å†…å®¹å¢é‡
âœ“ content_block_stop  - å†…å®¹å—ç»“æŸ
âœ“ message_delta       - æ¶ˆæ¯æ›´æ–°
âœ“ message_stop        - æ¶ˆæ¯ç»“æŸ
```

### 2. å·¥å…·è°ƒç”¨äº‹ä»¶
```
âœ“ tool_use_start  - å·¥å…·è°ƒç”¨å¼€å§‹ (id + name)
âœ“ tool_use_delta  - å·¥å…·è¾“å…¥ JSON å¢é‡
âœ“ JSON ç‰‡æ®µç´¯ç§¯  - è‡ªåŠ¨æ‹¼æ¥
âœ“ å®¹é”™è§£æ       - è‡ªåŠ¨ä¿®å¤ä¸å®Œæ•´ JSON
```

**ä»£ç ä½ç½®**:
```typescript
// src/core/client.ts:489-492
if (block.type === 'tool_use') {
  yield { type: 'tool_use_start', id: block.id, name: block.name };
}

// src/core/client.ts:486-487
} else if (delta.type === 'input_json_delta') {
  yield { type: 'tool_use_delta', input: delta.partial_json };
}
```

### 3. å®¹é”™ JSON è§£æ
æµ‹è¯•ç”¨ä¾‹é€šè¿‡ç‡: **100%**

| æµ‹è¯•ç”¨ä¾‹ | è¾“å…¥ | ç»“æœ |
|---------|------|------|
| æœªé—­åˆå¯¹è±¡ | `{"name": "test", "value": 123` | âœ… è‡ªåŠ¨è¡¥å…¨ `}` |
| æœªé—­åˆæ•°ç»„ | `{"items": [1, 2, 3` | âœ… è‡ªåŠ¨è¡¥å…¨ `]` |
| æœªé—­åˆå­—ç¬¦ä¸² | `{"message": "Hello World` | âœ… è‡ªåŠ¨è¡¥å…¨ `"` |
| å°¾éƒ¨é€—å· | `{"a": 1, "b": 2,}` | âœ… è‡ªåŠ¨ç§»é™¤ |

### 4. Delta ç±»å‹æ”¯æŒ
```
âœ“ text_delta       - æ–‡æœ¬å¢é‡
âœ“ thinking_delta   - Extended Thinking å¢é‡
âœ“ input_json_delta - å·¥å…·è¾“å…¥ JSON å¢é‡
âœ“ citations_delta  - å¼•ç”¨å¢é‡
âœ“ signature_delta  - ç­¾åå¢é‡
```

### 5. æµæ§åˆ¶åŠŸèƒ½
```
âœ“ AbortController  - ä¸­æ­¢æµ
âœ“ è¶…æ—¶æ§åˆ¶         - è‡ªåŠ¨è¶…æ—¶
âœ“ å¿ƒè·³æ£€æµ‹         - æ´»æ€§ç›‘æ§
âœ“ èƒŒå‹æ§åˆ¶         - äº‹ä»¶é˜Ÿåˆ—ç®¡ç†
âœ“ é”™è¯¯å¤„ç†         - å®Œå–„çš„é”™è¯¯æ¢å¤
```

## ğŸ” ä¸å®˜æ–¹å®ç°å¯¹æ¯”

### å®ç°æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | å®˜æ–¹å®ç° | æœ¬é¡¹ç›®å®ç° | ä¸€è‡´æ€§ |
|------|---------|-----------|--------|
| **äº‹ä»¶ç±»å‹** | 6 ç§æ ‡å‡†äº‹ä»¶ | 6 ç§æ ‡å‡†äº‹ä»¶ | âœ… 100% |
| **Delta ç±»å‹** | 5 ç§ delta | 5 ç§ delta | âœ… 100% |
| **JSON ç¼“å†²** | Symbol å­˜å‚¨ | Symbol å­˜å‚¨ | âœ… ç›¸åŒ |
| **å®¹é”™è§£æ** | `aA1()` å‡½æ•° | `parseTolerantJSON()` | âœ… é€»è¾‘ç›¸åŒ |
| **å·¥å…·äº‹ä»¶** | start + delta | start + delta | âœ… ç›¸åŒ |

### å…³é”®ä»£ç å¯¹æ¯”

**å®˜æ–¹ä»£ç ç‰‡æ®µ** (ä»æ··æ·†ä»£ç ä¸­æå–):
```javascript
case'input_json_delta':{
  if(G&&xzB(G)){
    let Z=G[SzB]||"";         // JSON ç¼“å†²
    Z+=Q.delta.partial_json;   // ç´¯ç§¯
    let Y={...G};
    Object.defineProperty(Y,SzB,{value:Z,enumerable:!1,writable:!0});
    Y.input=aA1(Z);            // å®¹é”™è§£æ
    B.content[Q.index]=Y
  }
  break
}
```

**æœ¬é¡¹ç›®å®ç°**:
```typescript
private applyInputJsonDelta(index: number, delta: any): void {
  const block = this.currentMessage!.content[index] as ToolUseContentBlock;
  if (!this.isToolUseBlock(block)) return;

  let jsonBuffer = (block as any)[this.JSON_BUF_SYMBOL] || '';
  jsonBuffer += delta.partial_json;
  (block as any)[this.JSON_BUF_SYMBOL] = jsonBuffer;

  block.input = parseTolerantJSON(jsonBuffer);  // å®¹é”™è§£æ
  this.callbacks.onInputJson?.(delta.partial_json, block.input);
}
```

**ç»“è®º**: å®ç°é€»è¾‘å®Œå…¨ä¸€è‡´ âœ…

## ğŸ§ª æµ‹è¯•ç»“æœ

### ç¤ºä¾‹ç¨‹åºæµ‹è¯•
```bash
npx tsx src/streaming/examples.ts
```

**ç»“æœ**:
```
âœ… ç¤ºä¾‹ 1: SSE è§£æå™¨          - é€šè¿‡
âœ… ç¤ºä¾‹ 2: å¢å¼ºçš„æ¶ˆæ¯æµå¤„ç†å™¨  - é€šè¿‡
âœ… ç¤ºä¾‹ 3: å®¹é”™ JSON è§£æ      - é€šè¿‡
âœ… ç¤ºä¾‹ 4: æµå–æ¶ˆ              - é€šè¿‡
âœ… ç¤ºä¾‹ 5: å·¥å…·è°ƒç”¨ JSON å¢é‡  - é€šè¿‡
```

### ç¼–è¯‘æµ‹è¯•
```bash
npm run build
```

**ç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸï¼Œ0 é”™è¯¯

### ç±»å‹æ£€æŸ¥
```bash
npx tsc --noEmit
```

**ç»“æœ**: âœ… ç±»å‹æ£€æŸ¥é€šè¿‡

## ğŸ“Š ä»£ç è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **ç±»å‹å®‰å…¨** | â­â­â­â­â­ | å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰ |
| **å¯è¯»æ€§** | â­â­â­â­â­ | æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ³¨é‡Š |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â­ | æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±• |
| **æµ‹è¯•è¦†ç›–** | â­â­â­â­ | åŒ…å«å®Œæ•´çš„ç¤ºä¾‹æµ‹è¯• |
| **æ–‡æ¡£è´¨é‡** | â­â­â­â­â­ | è¯¦ç»†çš„ README å’Œä»£ç æ³¨é‡Š |

## ğŸ“ å…³é”®å‘ç°

### 1. æ­£ç¡®å®ç°çš„åŠŸèƒ½
- âœ… å·¥å…·è°ƒç”¨æµå¼äº‹ä»¶æ­£ç¡®å‘å‡ºå’Œå¤„ç†
- âœ… JSON å¢é‡ç´¯ç§¯å’Œè§£æé€»è¾‘å®Œå…¨æ­£ç¡®
- âœ… å®¹é”™ JSON è§£æåŠŸèƒ½å®Œå–„
- âœ… æµæ§åˆ¶åŠŸèƒ½é½å…¨ï¼ˆä¸­æ­¢ã€è¶…æ—¶ã€å¿ƒè·³ï¼‰
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

### 2. ä»£ç ä¼˜åŠ¿
- **æ›´å¥½çš„ç±»å‹å®‰å…¨**: ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- **æ›´æ¸…æ™°çš„åˆ†å±‚**: client â†’ loop â†’ tools ä¸‰å±‚æ¶æ„
- **æ›´è¯¦ç»†çš„æ—¥å¿—**: ä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½
- **æ›´å®Œå–„çš„æ–‡æ¡£**: æ¯ä¸ªåŠŸèƒ½éƒ½æœ‰è¯¦ç»†è¯´æ˜

### 3. æ— éœ€ä¿®æ”¹
å½“å‰å®ç°å®Œå…¨ç¬¦åˆå®˜æ–¹æ ‡å‡†ï¼Œ**æ— éœ€ä»»ä½•ä¿®æ”¹**ã€‚

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. Symbol éšè—å±æ€§
ä½¿ç”¨ `Symbol` å­˜å‚¨ JSON ç¼“å†²åŒºï¼Œé¿å…æ±¡æŸ“å¯¹è±¡ï¼š
```typescript
private readonly JSON_BUF_SYMBOL = Symbol('__json_buf');
(block as any)[this.JSON_BUF_SYMBOL] = jsonBuffer;
```

### 2. å®¹é”™è§£æç®—æ³•
è‡ªåŠ¨ä¿®å¤ä¸å®Œæ•´çš„ JSONï¼š
```typescript
// è¡¥å…¨æœªé—­åˆçš„å¼•å·
if (openQuotes % 2 !== 0) fixed += '"';

// è¡¥å…¨æœªé—­åˆçš„æ•°ç»„
for (let i = 0; i < openBrackets - closeBrackets; i++) {
  fixed += ']';
}

// è¡¥å…¨æœªé—­åˆçš„å¯¹è±¡
for (let i = 0; i < openBraces - closeBraces; i++) {
  fixed += '}';
}
```

### 3. èƒŒå‹æ§åˆ¶
äº‹ä»¶é˜Ÿåˆ—é¿å…è¿‡è½½ï¼š
```typescript
if (this.eventQueue.length >= this.maxQueueSize) {
  console.warn('Event queue full, dropping event');
  return;
}
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **éªŒè¯æŠ¥å‘Š**: `VERIFICATION_STREAMING.md`
- **æ¨¡å—æ–‡æ¡£**: `src/streaming/README.md`
- **ç¤ºä¾‹ä»£ç **: `src/streaming/examples.ts`
- **å®˜æ–¹æºç **: `node_modules/@anthropic-ai/claude-code/cli.js`

## âœ¨ ç»“è®º

### éªŒè¯ç»“æœ: âœ… **å®Œå…¨é€šè¿‡**

å·¥å…·è°ƒç”¨æµå¼å¤„ç†åŠŸèƒ½çš„å®ç°**å®Œå…¨æ­£ç¡®**ï¼Œä¸å®˜æ–¹ Claude Code v2.0.76 ä¿æŒä¸€è‡´ï¼š

1. âœ… æ‰€æœ‰æµå¼äº‹ä»¶ç±»å‹æ­£ç¡®å¤„ç†
2. âœ… å·¥å…·è°ƒç”¨äº‹ä»¶å®Œæ•´æ”¯æŒ
3. âœ… å®¹é”™ JSON è§£æåŠŸèƒ½å®Œå–„
4. âœ… æµæ§åˆ¶åŠŸèƒ½é½å…¨
5. âœ… ä»£ç å¯ä»¥ç¼–è¯‘é€šè¿‡
6. âœ… ç±»å‹æ£€æŸ¥é€šè¿‡
7. âœ… ç¤ºä¾‹æµ‹è¯•å…¨éƒ¨é€šè¿‡

### å»ºè®®
æ— éœ€ä»»ä½•ä¿®æ”¹ã€‚å½“å‰å®ç°å·²è¾¾åˆ°ç”Ÿäº§çº§è´¨é‡ã€‚

---

**éªŒè¯å®Œæˆ**: 2025-12-28
**éªŒè¯äºº**: Claude AI
**é¡¹ç›®**: Claude Code å¼€æºé‡ç°é¡¹ç›®
**ç‰ˆæœ¬**: 2.0.76
